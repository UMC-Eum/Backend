name: CI/CD Pipeline

on:
  push:
    branches: ["main", "dev"]
  pull_request:
    branches: ["main", "dev"]
  workflow_dispatch:

concurrency:
  group: ci-cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    name: CI - Test & Build
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: eum_dev
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      NODE_ENV: test
      DATABASE_URL: mysql://root:root@127.0.0.1:3306/eum_dev
      REDIS_URL: redis://127.0.0.1:6379

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.20.0"
          cache: "npm"

      - name: Clean install dependencies
        run: |
          rm -rf node_modules .prisma
          npm ci

      - name: Prisma generate
        run: npm run prisma:generate

      - name: Prisma migrate (deploy)
        run: npx prisma migrate deploy

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Unit tests
        run: npm run test

      - name: Build
        run: npm run build

  cd:
    name: CD - Deploy to EC2
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/eum-backend:latest
            ${{ secrets.DOCKER_USERNAME }}/eum-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -euo pipefail

            DATABASE_URL='${{ secrets.PROD_DATABASE_URL }}'

            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/eum-backend:latest

            sudo docker run --rm \
              -e DATABASE_URL="$DATABASE_URL" \
              ${{ secrets.DOCKER_USERNAME }}/eum-backend:latest \
              npx prisma migrate deploy

            sudo docker stop eum-backend || true
            sudo docker rm eum-backend || true

            sudo docker run -d \
              --name eum-backend \
              --restart unless-stopped \
              -p 3000:3000 \
              -e PORT=3000 \
              -e NODE_ENV=production \
              -e DATABASE_URL="$DATABASE_URL" \
              -e REDIS_URL='${{ secrets.PROD_REDIS_URL }}' \
              -e JWT_SECRET='${{ secrets.PROD_JWT_SECRET }}' \
              -e JWT_ACCESS_SECRET='${{ secrets.PROD_JWT_ACCESS_SECRET }}' \
              -e JWT_ACCESS_EXPIRES_IN='${{ secrets.PROD_JWT_ACCESS_EXPIRES_IN }}' \
              -e JWT_REFRESH_SECRET='${{ secrets.PROD_JWT_REFRESH_SECRET }}' \
              -e KAKAO_CLIENT_ID='${{ secrets.PROD_KAKAO_CLIENT_ID }}' \
              -e KAKAO_CLIENT_SECRET='${{ secrets.PROD_KAKAO_CLIENT_SECRET }}' \
              -e AWS_ACCESS_KEY_ID='${{ secrets.PROD_AWS_ACCESS_KEY_ID }}' \
              -e AWS_SECRET_ACCESS_KEY='${{ secrets.PROD_AWS_SECRET_ACCESS_KEY }}' \
              -e AWS_REGION='${{ secrets.PROD_AWS_REGION }}' \
              -e AWS_S3_BUCKET='${{ secrets.PROD_AWS_S3_BUCKET }}' \
              ${{ secrets.DOCKER_USERNAME }}/eum-backend:latest

            sleep 10

            if sudo docker ps | grep -q eum-backend; then
              echo "Container started successfully"
            else
              echo "Container failed to start"
              sudo docker logs eum-backend || true
              exit 1
            fi

            for i in {1..10}; do
              if curl -fsS http://localhost:3000/api/v1/health > /dev/null; then
                echo "Health check passed"
                break
              else
                echo "Health check failed (attempt $i/10), retrying in 5 seconds..."
                sleep 5
              fi

              if [ "$i" -eq 10 ]; then
                echo "Health check failed after 10 attempts"
                sudo docker logs eum-backend || true
                exit 1
              fi
            done

            sudo docker image prune -f

      - name: Notify deployment result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "✅ Deployment completed successfully!"
          else
            echo "❌ Deployment failed!"
          fi

