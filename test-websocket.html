<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat API í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #f5f5f5;
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #007bff;
        padding-bottom: 10px;
      }
      h2 {
        color: #555;
        margin-top: 30px;
        border-left: 4px solid #007bff;
        padding-left: 10px;
      }
      .section {
        background: white;
        padding: 20px;
        margin: 20px 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .status {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 6px;
        font-weight: bold;
      }
      .status.connected {
        background: #d4edda;
        color: #155724;
      }
      .status.disconnected {
        background: #f8d7da;
        color: #721c24;
      }
      .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin: 15px 0;
      }
      input,
      select,
      textarea {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }
      button {
        padding: 10px 15px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      button.danger {
        background: #dc3545;
      }
      button.danger:hover {
        background: #c82333;
      }
      button.success {
        background: #28a745;
      }
      button.success:hover {
        background: #218838;
      }
      #messages {
        border: 1px solid #ddd;
        padding: 15px;
        height: 300px;
        overflow-y: auto;
        background: #f9f9f9;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
      }
      .message {
        margin: 5px 0;
        padding: 8px;
        background: white;
        border-left: 3px solid #007bff;
        border-radius: 4px;
      }
      .message.error {
        border-left-color: #dc3545;
      }
      .message.success {
        border-left-color: #28a745;
      }
      .message.warning {
        border-left-color: #ffc107;
      }
      .api-group {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
        border-left: 4px solid #007bff;
      }
      .api-group h3 {
        margin-top: 0;
        color: #007bff;
      }
      .response-box {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px;
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 11px;
        white-space: pre-wrap;
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ’¬ ì±„íŒ… API í…ŒìŠ¤íŠ¸ ë„êµ¬</h1>

    <!-- ê³µí†µ ì„¤ì • -->
    <div class="section">
      <h2>âš™ï¸ ì„¤ì •</h2>
      <div class="controls">
        <input
          type="text"
          id="apiBaseUrl"
          placeholder="API URL"
          value="http://localhost:3000/api/v1"
        />
        <input
          type="password"
          id="accessToken"
          placeholder="Access Token (JWT)"
        />
      </div>
    </div>

    <!-- WebSocket ì—°ê²° -->
    <div class="section">
      <h2>ğŸ”Œ ì‹¤ì‹œê°„ ì±„íŒ… (WebSocket)</h2>
      <div id="wsStatus" class="status disconnected">ğŸ”´ ì—°ê²° ì•ˆë¨</div>
      <div class="controls">
        <button onclick="connectWebSocket()" class="success">ì—°ê²°</button>
        <button onclick="disconnectWebSocket()" class="danger">
          ì—°ê²° ëŠê¸°
        </button>
        <button onclick="pingWS()">Ping</button>
      </div>

      <!-- ì±„íŒ…ë°© ì…ì¥ & ë©”ì‹œì§€ ì „ì†¡ (WebSocketìš©) -->
      <div class="api-group">
        <h3>room.join - ì±„íŒ…ë°© ì…ì¥</h3>
        <div class="controls">
          <input
            type="number"
            id="chatRoomId"
            placeholder="ì±„íŒ…ë°© ID"
            value="3"
            min="1"
          />
          <button onclick="joinRoomWS()">ì…ì¥</button>
        </div>
      </div>

      <div class="api-group">
        <h3>message.send - ë©”ì‹œì§€ ì „ì†¡ (ì‹¤ì‹œê°„)</h3>
        <div class="controls">
          <select id="msgType">
            <option value="TEXT">TEXT</option>
            <option value="AUDIO">AUDIO</option>
            <option value="PHOTO">PHOTO</option>
            <option value="VIDEO">VIDEO</option>
          </select>
          <input
            type="text"
            id="msgText"
            placeholder="ë©”ì‹œì§€ ë‚´ìš©"
            value="ì•ˆë…•í•˜ì„¸ìš”!"
          />
          <input type="text" id="msgMediaUrl" placeholder="ë¯¸ë””ì–´ URL" />
          <input
            type="number"
            id="msgDuration"
            placeholder="ê¸¸ì´(ì´ˆ)"
            value="5"
            min="1"
          />
          <button onclick="sendMessageWS()">ì „ì†¡</button>
        </div>
      </div>
    </div>

    <!-- REST API (ì´ˆê¸° ë°ì´í„° ë¡œë“œìš©) -->
    <div class="section">
      <h2>ğŸ“¡ ì±„íŒ…ë°© ê´€ë¦¬ (REST API)</h2>

      <div class="api-group">
        <h3>POST /chats/rooms - ìƒˆ ì±„íŒ…ë°© ìƒì„±</h3>
        <p style="font-size: 12px; color: #666">
          ìƒëŒ€ë°©ê³¼ ì²˜ìŒ ë§Œë‚  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        </p>
        <div class="controls">
          <input
            type="number"
            id="targetUserId"
            placeholder="ìƒëŒ€ë°© ID"
            value="2"
            min="1"
          />
          <button onclick="createRoom()">ìƒì„±</button>
        </div>
        <div id="createRoomResponse" class="response-box"></div>
      </div>

      <div class="api-group">
        <h3>GET /chats/rooms - ë‚´ ì±„íŒ…ë°© ëª©ë¡</h3>
        <p style="font-size: 12px; color: #666">
          ë¡œê·¸ì¸ í›„ ë‚´ê°€ ì°¸ì—¬ ì¤‘ì¸ ì±„íŒ…ë°©ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
        </p>
        <div class="controls">
          <button onclick="listRooms()">ëª©ë¡ ì¡°íšŒ</button>
        </div>
        <div id="listRoomsResponse" class="response-box"></div>
      </div>

      <div class="api-group">
        <h3>GET /chats/rooms/{id} - ì±„íŒ…ë°© ìƒì„¸</h3>
        <div class="controls">
          <input
            type="number"
            id="roomDetailId"
            placeholder="ì±„íŒ…ë°© ID"
            value="3"
            min="1"
          />
          <button onclick="getRoomDetail()">ì¡°íšŒ</button>
        </div>
        <div id="roomDetailResponse" class="response-box"></div>
      </div>

      <div class="api-group">
        <h3>GET /chats/rooms/{id}/messages - ê³¼ê±° ë©”ì‹œì§€ ì¡°íšŒ</h3>
        <p style="font-size: 12px; color: #666">
          ì±„íŒ…ë°© ì…ì¥ ì‹œ ì´ì „ ë©”ì‹œì§€ë“¤ì„ ë°›ì•„ì˜µë‹ˆë‹¤.
        </p>
        <div class="controls">
          <input
            type="number"
            id="msgRoomId"
            placeholder="ì±„íŒ…ë°© ID"
            value="3"
            min="1"
          />
          <button onclick="listMessages()">ì¡°íšŒ</button>
        </div>
        <div id="listMessagesResponse" class="response-box"></div>
      </div>
    </div>

    <!-- ë¡œê·¸ -->
    <div class="section">
      <h2>ğŸ“‹ ë¡œê·¸</h2>
      <div id="messages"></div>
    </div>

    <script>
      let socket = null;

      // ============ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ============
      function getWebSocketUrl() {
        const apiBaseUrl =
          document.getElementById('apiBaseUrl').value ||
          'http://localhost:3000/api/v1';
        return apiBaseUrl
          .replace('http://', 'ws://')
          .replace('https://', 'wss://')
          .replace('/api/v1', '');
      }

      function addLog(message, type = 'info') {
        const logsEl = document.getElementById('messages');
        const logEl = document.createElement('div');
        logEl.className = `message ${type}`;
        logEl.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logsEl.appendChild(logEl);
        logsEl.scrollTop = logsEl.scrollHeight;
      }

      function updateWSStatus(connected) {
        const statusEl = document.getElementById('wsStatus');
        if (connected) {
          statusEl.className = 'status connected';
          statusEl.textContent = 'ğŸŸ¢ WebSocket ì—°ê²°ë¨';
        } else {
          statusEl.className = 'status disconnected';
          statusEl.textContent = 'ğŸ”´ WebSocket ì—°ê²° ì•ˆë¨';
        }
      }

      function showResponse(elementId, data, isError = false) {
        const el = document.getElementById(elementId);
        if (!el) return;
        el.style.display = 'block';
        el.textContent = JSON.stringify(data, null, 2);
        el.style.borderLeftColor = isError ? '#dc3545' : '#28a745';
      }

      // ============ WebSocket í•¨ìˆ˜ ============
      function connectWebSocket() {
        const token = document.getElementById('accessToken').value;

        if (!token) {
          addLog('âŒ í† í°ì´ ì—†ìŠµë‹ˆë‹¤. JWT access_tokenì„ ì…ë ¥í•˜ì„¸ìš”.', 'error');
          return;
        }

        const wsUrl = getWebSocketUrl();

        socket = io(`${wsUrl}/chats`, {
          path: '/ws',
          auth: { token },
          transports: ['websocket'],
          reconnection: true,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 5000,
          reconnectionAttempts: 5,
        });

        socket.on('connect', () => {
          addLog('âœ… WebSocket ì—°ê²° ì„±ê³µ!', 'success');
          updateWSStatus(true);
        });

        socket.on('disconnect', () => {
          addLog('âš ï¸ WebSocket ì—°ê²° ëŠê¹€', 'warning');
          updateWSStatus(false);
        });

        socket.on('connect_error', (error) => {
          addLog(`âŒ ì—°ê²° ì˜¤ë¥˜: ${error.message}`, 'error');
        });

        socket.on('message.new', (msg) => {
          addLog(
            `ğŸ“¨ ìƒˆ ë©”ì‹œì§€: [${msg.senderUserId}] ${msg.text || `[${msg.type}]`}`,
            'success',
          );
        });

        socket.on('exception', (error) => {
          addLog(`âŒ ì˜¤ë¥˜: ${JSON.stringify(error)}`, 'error');
        });
      }

      function disconnectWebSocket() {
        if (socket) {
          socket.disconnect();
          addLog('WebSocket ì—°ê²°ì„ ë‹«ì•˜ìŠµë‹ˆë‹¤.', 'warning');
          updateWSStatus(false);
        }
      }

      function pingWS() {
        if (!socket?.connected) {
          addLog('âŒ WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
          return;
        }

        socket.emit('ping', (res) => {
          addLog(`ğŸ“ Ping! ${JSON.stringify(res)}`, 'success');
        });
      }

      function joinRoomWS() {
        if (!socket?.connected) {
          addLog('âŒ WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
          return;
        }

        const chatRoomId = parseInt(
          document.getElementById('chatRoomId').value,
        );
        if (!chatRoomId) {
          addLog('âŒ ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
          return;
        }

        socket.emit('room.join', { chatRoomId }, (res) => {
          if (res.ok) {
            addLog(`âœ… ì±„íŒ…ë°© ì…ì¥: ${res.joined}`, 'success');
          } else {
            addLog(`âŒ ì…ì¥ ì‹¤íŒ¨`, 'error');
          }
        });
      }

      function sendMessageWS() {
        if (!socket?.connected) {
          addLog('âŒ WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
          return;
        }

        const chatRoomId = parseInt(
          document.getElementById('chatRoomId').value,
        );
        const type = document.getElementById('msgType').value;
        const text = document.getElementById('msgText').value;
        const mediaUrl = document.getElementById('msgMediaUrl').value;
        const durationSec = parseInt(
          document.getElementById('msgDuration').value,
        );

        if (!chatRoomId) {
          addLog('âŒ ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
          return;
        }

        const payload = {
          chatRoomId,
          type,
          text: type === 'TEXT' ? text : null,
          mediaUrl: type !== 'TEXT' ? mediaUrl : null,
          durationSec: type === 'AUDIO' ? durationSec : null,
        };

        socket.emit('message.send', payload, (res) => {
          if (res.ok) {
            addLog(`âœ… ë©”ì‹œì§€ ì „ì†¡ ì„±ê³µ!`, 'success');
            document.getElementById('msgText').value = '';
          }
        });
      }

      // ============ REST API í•¨ìˆ˜ ============
      async function apiCall(method, endpoint, body = null) {
        const apiBase =
          document.getElementById('apiBaseUrl').value ||
          'http://localhost:3000/api/v1';
        const token = document.getElementById('accessToken').value;

        const url = `${apiBase}${endpoint}`;

        const options = {
          method,
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
        };

        if (body) options.body = JSON.stringify(body);

        try {
          const response = await fetch(url, options);
          const data = await response.json();

          addLog(
            `${method} ${endpoint} - ${response.status}`,
            response.ok ? 'success' : 'error',
          );
          return { ok: response.ok, data };
        } catch (error) {
          addLog(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${error.message}`, 'error');
          return { ok: false, error: error.message };
        }
      }

      async function createRoom() {
        const targetUserId = parseInt(
          document.getElementById('targetUserId').value,
        );
        if (!targetUserId) {
          addLog('âŒ ìƒëŒ€ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
          return;
        }

        const result = await apiCall('POST', '/chats/rooms', { targetUserId });
        showResponse('createRoomResponse', result.data, !result.ok);
      }

      async function listRooms() {
        const result = await apiCall('GET', '/chats/rooms');
        showResponse('listRoomsResponse', result.data, !result.ok);
      }

      async function getRoomDetail() {
        const roomId = parseInt(document.getElementById('roomDetailId').value);
        if (!roomId) {
          addLog('âŒ ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
          return;
        }

        const result = await apiCall('GET', `/chats/rooms/${roomId}`);
        showResponse('roomDetailResponse', result.data, !result.ok);
      }

      async function listMessages() {
        const roomId = parseInt(document.getElementById('msgRoomId').value);
        if (!roomId) {
          addLog('âŒ ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'error');
          return;
        }

        const result = await apiCall('GET', `/chats/rooms/${roomId}/messages`);
        showResponse('listMessagesResponse', result.data, !result.ok);
      }

      // ì´ˆê¸°í™”
      document.addEventListener('DOMContentLoaded', () => {
        updateWSStatus(false);
        addLog(
          'ì¤€ë¹„ë¨. Access Tokenì„ ì…ë ¥í•˜ê³  WebSocketì„ ì—°ê²°í•˜ì„¸ìš”.',
          'info',
        );
      });
    </script>
  </body>
</html>
